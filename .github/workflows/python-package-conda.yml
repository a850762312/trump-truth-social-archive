name: Trump Truth Social Archive & Notify

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆæ•´ç‚¹ï¼‰

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      # 4. è¿è¡Œçˆ¬è™«è„šæœ¬
      - name: Run scraper
        run: python scrape.py
        env:
          SCRAPE_PROXY_KEY: ${{ secrets.SCRAPE_PROXY_KEY }}
      
      # 5. å®‰è£…é€šçŸ¥è„šæœ¬ä¾èµ–
      - name: Install notification dependencies
        run: pip install python-dateutil
      
      # 6. è¿è¡Œé€šçŸ¥è„šæœ¬
      - name: Run notification
        env:
          DINGTALK_ACCESS_TOKEN: ${{ secrets.DINGTALK_ACCESS_TOKEN }}
          DINGTALK_OPEN_CONVERSATION_ID: ${{ secrets.DINGTALK_OPEN_CONVERSATION_ID }}
          DINGTALK_ROBOT_CODE: ${{ secrets.DINGTALK_ROBOT_CODE }}
        run: |
          # åˆ›å»ºé€šçŸ¥è„šæœ¬
          cat << 'EOF' > send_updates.py
          import os
          import json
          import requests
          from datetime import datetime, timezone, timedelta
          import hashlib
          import dateutil.parser
          
          # é…ç½®å‚æ•°
          ACCESS_TOKEN = os.environ['DINGTALK_ACCESS_TOKEN']
          OPEN_CONVERSATION_ID = os.environ['DINGTALK_OPEN_CONVERSATION_ID']
          ROBOT_CODE = os.environ['DINGTALK_ROBOT_CODE']
          JSON_URL = "https://raw.githubusercontent.com/${{ github.repository }}/main/data/truth_archive.json"
          HISTORY_FILE = "posted_messages.txt"
          
          def send_dingtalk_message(content):
              """å‘é€æ¶ˆæ¯åˆ°é’‰é’‰ç¾¤"""
              url = "https://api.dingtalk.com/v1.0/robot/groupMessages/send"
              headers = {
                  "Content-Type": "application/json",
                  "x-acs-dingtalk-access-token": ACCESS_TOKEN
              }
              payload = {
                  "msgKey": "sampleText",
                  "msgParam": json.dumps({"content": content}),
                  "openConversationId": OPEN_CONVERSATION_ID,
                  "robotCode": ROBOT_CODE
              }
              response = requests.post(url, headers=headers, json=payload)
              return response.json()
          
          def utc_to_beijing(utc_str):
              """UTCæ—¶é—´è½¬åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰"""
              utc_time = dateutil.parser.isoparse(utc_str)
              beijing_time = utc_time.astimezone(timezone(timedelta(hours=8)))
              return beijing_time.strftime("%Y-%m-%d %H:%M:%S")
          
          def get_content_hash(content):
              """ç”Ÿæˆå†…å®¹å“ˆå¸Œå€¼ç”¨äºå»é‡"""
              return hashlib.md5(content.encode()).hexdigest()
          
          def load_posted_hashes():
              """åŠ è½½å·²å‘é€æ¶ˆæ¯çš„å“ˆå¸Œè®°å½•"""
              if os.path.exists(HISTORY_FILE):
                  with open(HISTORY_FILE, 'r') as f:
                      return set(f.read().splitlines())
              return set()
          
          def save_posted_hashes(hashes):
              """ä¿å­˜æ–°çš„å“ˆå¸Œè®°å½•"""
              with open(HISTORY_FILE, 'w') as f:
                  f.write('\n'.join(hashes))
          
          # ä¸»é€»è¾‘
          try:
              posted_hashes = load_posted_hashes()
              new_hashes = set()
              
              # è·å–æœ€æ–°JSONæ•°æ®
              response = requests.get(JSON_URL)
              response.raise_for_status()
              data = response.json()
              
              # å¤„ç†æ–°æ¶ˆæ¯
              new_messages = []
              for item in data:
                  content_hash = get_content_hash(item['content'])
                  if content_hash not in posted_hashes:
                      new_messages.append(item)
                      new_hashes.add(content_hash)
              
              if not new_messages:
                  print("æ²¡æœ‰å‘ç°æ–°å†…å®¹")
                  exit(0)
              
              # é€†åºå¤„ç†ï¼ˆä¿è¯æ˜¾ç¤ºé¡ºåºæ­£ç¡®ï¼‰
              for item in reversed(new_messages):
                  beijing_time = utc_to_beijing(item['created_at'])
                  message_content = f"ğŸ•’ åŒ—äº¬æ—¶é—´: {beijing_time}\nğŸ“ å†…å®¹: {item['content']}"
                  
                  try:
                      result = send_dingtalk_message(message_content)
                      print(f"å‘é€æˆåŠŸ: {item['id']}")
                  except Exception as e:
                      print(f"å‘é€å¤±è´¥: {item['id']}, é”™è¯¯: {str(e)}")
              
              # æ›´æ–°å†å²è®°å½•
              posted_hashes.update(new_hashes)
              save_posted_hashes(posted_hashes)
              print(f"æ–°å¢ {len(new_messages)} æ¡è®°å½•å·²ä¿å­˜")
          
          except Exception as e:
              print(f"å¤„ç†å¤±è´¥: {str(e)}")
              exit(1)
          EOF
          
          # æ‰§è¡Œé€šçŸ¥è„šæœ¬
          python send_updates.py
      
      # 7. æäº¤æ‰€æœ‰æ›´æ–°ï¼ˆåŒ…æ‹¬çˆ¬å–çš„æ•°æ®å’Œå†å²è®°å½•ï¼‰
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions@example.com"
          git config --local user.name "GitHub Actions"
          git add data/ posted_messages.txt
          git commit -m "Auto-update: $(date +'%Y-%m-%d %H:%M')" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
